#pragma version 8
intcblock 0 1 4
bytecblock 0x61737365745f6964 0x61756374696f6e656572 0x686967686573745f626964 0x65787069726564 0x686967686573745f626964646572 0x626964
txn NumAppArgs
intc_0 // 0
==
bnz main_l8
txna ApplicationArgs 0
pushbytes 0xa948021c // "start(txn,uint64)void"
==
bnz main_l7
txna ApplicationArgs 0
pushbytes 0x611a050b // "bid(address,txn)void"
==
bnz main_l6
txna ApplicationArgs 0
pushbytes 0x2c09f3a5 // "end()void"
==
bnz main_l5
err
main_l5:
txn OnCompletion
intc_0 // NoOp
==
txn ApplicationID
intc_0 // 0
!=
&&
assert
callsub endcaster_6
intc_1 // 1
return
main_l6:
txn OnCompletion
intc_0 // NoOp
==
txn ApplicationID
intc_0 // 0
!=
&&
txn OnCompletion
intc_1 // OptIn
==
txn ApplicationID
intc_0 // 0
!=
&&
||
assert
callsub bidcaster_5
intc_1 // 1
return
main_l7:
txn OnCompletion
intc_0 // NoOp
==
txn ApplicationID
intc_0 // 0
!=
&&
assert
callsub startcaster_4
intc_1 // 1
return
main_l8:
txn OnCompletion
intc_0 // NoOp
==
bnz main_l10
err
main_l10:
txn ApplicationID
intc_0 // 0
==
assert
intc_1 // 1
return

// start
start_0:
proto 2 0
txn Sender
intc_0 // 0
bytec_1 // "auctioneer"
app_local_get_ex
store 1
store 0
load 1
!
assert
txn Sender
bytec_1 // "auctioneer"
txn Sender
app_local_put
txn Sender
bytec_0 // "asset_id"
frame_dig -1
app_local_put
txn Sender
bytec_2 // "highest_bid"
frame_dig -2
gtxns Amount
app_local_put
txn Sender
bytec_3 // "expired"
intc_1 // 1
app_local_put
retsub

// bid
bid_1:
proto 2 0
frame_dig -2
bytec_3 // "expired"
app_local_get
intc_1 // 1
==
// Auction is not active
assert
frame_dig -2
bytec_0 // "asset_id"
app_local_get
intc_0 // 0
==
bnz bid_1_l2
frame_dig -1
gtxns TypeEnum
intc_2 // axfer
==
// Expected ASA transfer
assert
frame_dig -1
gtxns XferAsset
frame_dig -2
bytec_0 // "asset_id"
app_local_get
==
// Wrong ASA ID
assert
frame_dig -1
gtxns AssetReceiver
global CurrentApplicationAddress
==
// ASA must be sent to application address
assert
b bid_1_l3
bid_1_l2:
frame_dig -1
gtxns TypeEnum
intc_1 // pay
==
// Expected Algo payment
assert
bid_1_l3:
frame_dig -1
gtxns Amount
frame_dig -2
bytec_2 // "highest_bid"
app_local_get
>
// Bid too low
assert
frame_dig -2
bytec_0 // "asset_id"
app_local_get
frame_dig -2
bytec 4 // "highest_bidder"
app_local_get
frame_dig -2
bytec 4 // "highest_bidder"
app_local_get
bytec 5 // "bid"
app_local_get
callsub payorclose_3
txn Sender
bytec 5 // "bid"
frame_dig -1
gtxns Amount
app_local_put
frame_dig -2
bytec 4 // "highest_bidder"
txn Sender
app_local_put
frame_dig -2
bytec_2 // "highest_bid"
frame_dig -1
gtxns Amount
app_local_put
retsub

// end
end_2:
proto 0 0
txn Sender
txn Sender
bytec_1 // "auctioneer"
app_local_get
==
// Only auctioneer can end auction
assert
txn Sender
bytec_3 // "expired"
app_local_get
intc_1 // 1
==
// Auction already ended
assert
txn Sender
bytec_0 // "asset_id"
app_local_get
txn Sender
bytec_1 // "auctioneer"
app_local_get
txn Sender
bytec_2 // "highest_bid"
app_local_get
callsub payorclose_3
txn Sender
bytec_3 // "expired"
pushint 2 // 2
app_local_put
retsub

// pay_or_close
payorclose_3:
proto 3 0
frame_dig -1
intc_0 // 0
>
bz payorclose_3_l6
frame_dig -3
intc_0 // 0
==
bnz payorclose_3_l3
itxn_begin
intc_2 // axfer
itxn_field TypeEnum
frame_dig -3
itxn_field XferAsset
frame_dig -2
itxn_field AssetReceiver
frame_dig -1
itxn_field AssetAmount
intc_0 // 0
itxn_field Fee
itxn_submit
b payorclose_3_l6
payorclose_3_l3:
global CurrentApplicationAddress
balance
frame_dig -1
-
pushint 100000 // 100000
<
bnz payorclose_3_l5
itxn_begin
intc_1 // pay
itxn_field TypeEnum
frame_dig -2
itxn_field Receiver
frame_dig -1
itxn_field Amount
intc_0 // 0
itxn_field Fee
itxn_submit
b payorclose_3_l6
payorclose_3_l5:
itxn_begin
intc_1 // pay
itxn_field TypeEnum
frame_dig -2
itxn_field CloseRemainderTo
intc_0 // 0
itxn_field Fee
itxn_submit
payorclose_3_l6:
retsub

// start_caster
startcaster_4:
proto 0 0
intc_0 // 0
dup
txna ApplicationArgs 1
btoi
frame_bury 1
txn GroupIndex
intc_1 // 1
-
frame_bury 0
frame_dig 0
frame_dig 1
callsub start_0
retsub

// bid_caster
bidcaster_5:
proto 0 0
pushbytes 0x // ""
intc_0 // 0
txna ApplicationArgs 1
frame_bury 0
txn GroupIndex
intc_1 // 1
-
frame_bury 1
frame_dig 0
frame_dig 1
callsub bid_1
retsub

// end_caster
endcaster_6:
proto 0 0
callsub end_2
retsub